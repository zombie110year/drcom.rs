# 2021-05-09

从 [Hagb/CQU_drcom](https://github.com/purefkh/CQU_drcom/pull/31/files) 处得知，在 `keep_alive_stable` 阶段中，服务器可能会返回

```
检测发现 1 次, 2 次后处理 , 终端 > 2,
```

的 GBK 字符串，这时将会导致中断，需要重新登录。

```log
[2021-05-09T11:13:16Z TRACE drcom::app keep_alive_3 recv(42)]
4d 38 bc cf bc ec b2 e2 b7 a2 cf d6 20 31 20 b4
ce 2c 20 32 20 b4 ce ba f3 b4 a6 c0 ed 20 2c 20
d6 d5 b6 cb 20 3e 20 32 2c 20
M8枷检测发现 1 次, 2 次后处理 , 终端 > 2,
```

+ header `4d 38 bc cf`

# 2021-05-10

发现重启客户端时仍然会出现连续的登录失败，且在 `challenge` 阶段返回 `05 00 00 05 03`，查询 [drcom-generic :: error_no](https://github.com/drcoms/drcom-generic/blob/master/analyses/error_no.md) 得知是登录包的错误。

1. 根据 [drcom-generic :: issue 245](https://github.com/drcoms/drcom-generic/issues/245#issuecomment-328854233)，可能是学校的 Drcom 客户端会在用户名中加盐，可以等待安装官方客户端后抓包查看；
2. 根据 [purefkh/CQU_drcom](https://github.com/purefkh/CQU_drcom/blob/master/setup.sh)，得知学校更换了一些参数，配置脚本中用 base64 保存了一些现成的新配置。

<details>
<summary>
报错的日志
</summary>

```log
[2021-05-10T09:15:01Z TRACE drcom::app] keep_alive_3 sent (40) [7, 105, 40, 0, 11, 1, 220, 2, 47, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
[2021-05-10T09:15:01Z TRACE drcom::app] keep_alive_3 recv(42) [77, 56, 12, 142, 188, 236, 178, 226, 183, 162, 207, 214, 32, 49, 32, 180, 206, 44, 32, 50, 32, 180, 206, 186, 243, 180, 166, 192, 237, 32, 44, 32, 214, 213, 182, 203, 32, 62, 32, 50, 44, 32]
[2021-05-10T09:15:01Z ERROR drcom_cli] 被检测到多设备，立刻重启！
[2021-05-10T09:15:01Z TRACE drcom::app] challenge sent(20) [1, 2, 143, 250, 9, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
[2021-05-10T09:15:01Z TRACE drcom::app] challenge recv(272) [7, 105, 16, 1, 11, 6, 216, 2, 47, 18, 0, 0, 0, 0, 0, 0, 168, 162, 0, 0, 41, 77, 77, 63, 0, 0, 0, 0, 216, 2, 0, 0, 77, 90, 144, 0, 3, 0, 0, 0, 4, 0, 0, 0, 255, 255, 0, 0, 184, 0, 0, 0, 0, 0, 0, 0, 64, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 8, 1, 0, 0, 14, 31, 186, 14, 0, 180, 9, 205, 33, 184, 1, 76, 205, 33, 84, 104, 105, 115, 32, 112, 114, 111, 103, 114, 97, 109, 32, 99, 97, 110, 110, 111, 116, 32, 98, 101, 32, 114, 117, 110, 32, 105, 110, 32, 68, 79, 83, 32, 109, 111, 100, 101, 46, 13, 13, 10, 36, 0, 0, 0, 0, 0, 0, 0, 190, 79, 249, 89, 250, 46, 151, 10, 250, 46, 151, 10, 250, 46, 151, 10, 163, 13, 132, 10, 248, 46, 151, 10, 129, 50, 155, 10, 254, 46, 151, 10, 121, 38, 202, 10, 240, 46, 151, 10, 121, 50, 153, 10, 248, 46, 151, 10, 149, 49, 156, 10, 251, 46, 151, 10, 149, 49, 157, 10, 255, 46, 151, 10, 149, 49, 147, 10, 248, 46, 151, 10, 250, 46, 150, 10, 73, 46, 151, 10, 204, 8, 147, 10, 249, 46, 151, 10, 204, 8, 156, 10, 242, 46, 151, 10, 61, 40, 145, 10, 251, 46, 151, 10, 5, 14, 147, 10, 249, 46, 151, 10]
[2021-05-10T09:15:01Z WARN  drcom::app] challenge err(272) [7, 105, 16, 1, 11, 6, 216, 2, 47, 18, 0, 0, 0, 0, 0, 0, 168, 162, 0, 0, 41, 77, 77, 63, 0, 0, 0, 0, 216, 2, 0, 0, 77, 90, 144, 0, 3, 0, 0, 0, 4, 0, 0, 0, 255, 255, 0, 0, 184, 0, 0, 0, 0, 0, 0, 0, 64, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 8, 1, 0, 0, 14, 31, 186, 14, 0, 180, 9, 205, 33, 184, 1, 76, 205, 33, 84, 104, 105, 115, 32, 112, 114, 111, 103, 114, 97, 109, 32, 99, 97, 110, 110, 111, 116, 32, 98, 101, 32, 114, 117, 110, 32, 105, 110, 32, 68, 79, 83, 32, 109, 111, 100, 101, 46, 13, 13, 10, 36, 0, 0, 0, 0, 0, 0, 0, 190, 79, 249, 89, 250, 46, 151, 10, 250, 46, 151, 10, 250, 46, 151, 10, 163, 13, 132, 10, 248, 46, 151, 10, 129, 50, 155, 10, 254, 46, 151, 10, 121, 38, 202, 10, 240, 46, 151, 10, 121, 50, 153, 10, 248, 46, 151, 10, 149, 49, 156, 10, 251, 46, 151, 10, 149, 49, 157, 10, 255, 46, 151, 10, 149, 49, 147, 10, 248, 46, 151, 10, 250, 46, 150, 10, 73, 46, 151, 10, 204, 8, 147, 10, 249, 46, 151, 10, 204, 8, 156, 10, 242, 46, 151, 10, 61, 40, 145, 10, 251, 46, 151, 10, 5, 14, 147, 10, 249, 46, 151, 10]
[2021-05-10T09:15:01Z ERROR drcom::app] challenge 失败
[2021-05-10T09:15:01Z WARN  drcom::app] 10 秒后重试
[2021-05-10T09:15:11Z TRACE drcom::app] challenge sent(20) [1, 2, 175, 249, 9, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
[2021-05-10T09:15:11Z TRACE drcom::app] challenge recv(76) [2, 2, 143, 250, 124, 8, 115, 2, 0, 0, 1, 0, 243, 3, 232, 240, 0, 0, 0, 0, 172, 25, 148, 201, 11, 184, 168, 162, 0, 0, 41, 77, 77, 63, 0, 0, 0, 0, 216, 2, 0, 0, 1, 0, 32, 1, 13, 168, 200, 0, 255, 255, 0, 0, 0, 0, 0, 0, 242, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
[2021-05-10T09:15:11Z TRACE drcom::app] salt set(4) [124, 8, 115, 2]
[2021-05-10T09:15:11Z TRACE drcom::app] login sent(330) [3, 1, 0, 28, 66, 254, 121, 90, 209, 12, 9, 97, 185, 68, 213, 101, 164, 171, 12, 82, 50, 48, 49, 55, 50, 55, 53, 49, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 32, 7, 134, 99, 148, 248, 51, 50, 114, 170, 217, 236, 190, 151, 19, 224, 154, 198, 245, 24, 137, 182, 108, 234, 1, 192, 168, 31, 214, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 93, 0, 2, 56, 147, 219, 239, 113, 1, 0, 0, 0, 0, 88, 105, 97, 111, 77, 105, 32, 82, 111, 117, 116, 101, 114, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 8, 8, 8, 8, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 148, 0, 0, 0, 5, 0, 0, 0, 1, 0, 0, 0, 40, 10, 0, 0, 2, 0, 0, 0, 76, 105, 110, 117, 120, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 10, 0, 2, 12, 224, 187, 188, 24, 0, 0, 196, 157, 237, 162, 226, 62, 0, 0, 233, 19]
[2021-05-10T09:15:11Z TRACE drcom::app] login recv(76) [2, 2, 175, 249, 155, 8, 115, 2, 0, 0, 1, 0, 243, 3, 232, 240, 0, 0, 0, 0, 172, 25, 148, 201, 11, 184, 168, 162, 0, 0, 41, 77, 77, 63, 0, 0, 0, 0, 216, 2, 0, 0, 1, 0, 32, 1, 13, 168, 200, 0, 255, 255, 0, 0, 0, 0, 0, 0, 242, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
[2021-05-10T09:15:11Z ERROR drcom::app] 未知的登录错误
[2021-05-10T09:15:11Z WARN  drcom::app] 20 秒后重试
[2021-05-10T09:15:31Z TRACE drcom::app] challenge sent(20) [1, 2, 150, 250, 9, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
[2021-05-10T09:15:31Z TRACE drcom::app] challenge recv(5) [5, 0, 0, 5, 3]
[2021-05-10T09:15:31Z WARN  drcom::app] challenge err(5) [5, 0, 0, 5, 3]
[2021-05-10T09:15:31Z ERROR drcom::app] challenge 失败
[2021-05-10T09:15:31Z WARN  drcom::app] 40 秒后重试
[2021-05-10T09:16:11Z TRACE drcom::app] challenge sent(20) [1, 2, 123, 250, 9, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
[2021-05-10T09:16:11Z TRACE drcom::app] challenge recv(76) [2, 2, 150, 250, 212, 8, 115, 2, 0, 0, 1, 0, 243, 3, 232, 240, 0, 0, 0, 0, 172, 25, 148, 201, 11, 184, 168, 162, 0, 0, 41, 77, 77, 63, 0, 0, 0, 0, 216, 2, 0, 0, 1, 0, 32, 1, 13, 168, 200, 0, 255, 255, 0, 0, 0, 0, 0, 0, 242, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
[2021-05-10T09:16:11Z TRACE drcom::app] salt set(4) [212, 8, 115, 2]
[2021-05-10T09:16:11Z TRACE drcom::app] login sent(330) [3, 1, 0, 28, 81, 162, 234, 190, 162, 149, 108, 164, 83, 43, 165, 70, 149, 113, 177, 50, 50, 48, 49, 55, 50, 55, 53, 49, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 32, 7, 149, 63, 7, 28, 64, 171, 30, 253, 96, 41, 53, 164, 241, 23, 21, 8, 168, 224, 214, 208, 180, 248, 1, 192, 168, 31, 214, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 150, 119, 244, 13, 214, 163, 122, 48, 1, 0, 0, 0, 0, 88, 105, 97, 111, 77, 105, 32, 82, 111, 117, 116, 101, 114, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 8, 8, 8, 8, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 148, 0, 0, 0, 5, 0, 0, 0, 1, 0, 0, 0, 40, 10, 0, 0, 2, 0, 0, 0, 76, 105, 110, 117, 120, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 10, 0, 2, 12, 176, 160, 18, 131, 0, 0, 196, 157, 237, 162, 226, 62, 0, 0, 233, 19]
[2021-05-10T09:16:11Z TRACE drcom::app] login recv(76) [2, 2, 123, 250, 67, 9, 115, 2, 0, 0, 1, 0, 243, 3, 232, 240, 0, 0, 0, 0, 172, 25, 148, 201, 11, 184, 168, 162, 0, 0, 41, 77, 77, 63, 0, 0, 0, 0, 216, 2, 0, 0, 1, 0, 32, 1, 13, 168, 200, 0, 255, 255, 0, 0, 0, 0, 0, 0, 242, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
[2021-05-10T09:16:11Z ERROR drcom::app] 未知的登录错误
[2021-05-10T09:16:11Z WARN  drcom::app] 80 秒后重试
[2021-05-10T09:17:31Z TRACE drcom::app] challenge sent(20) [1, 2, 167, 250, 9, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
[2021-05-10T09:17:31Z TRACE drcom::app] challenge recv(5) [5, 0, 0, 5, 3]
[2021-05-10T09:17:31Z WARN  drcom::app] challenge err(5) [5, 0, 0, 5, 3]
[2021-05-10T09:17:31Z ERROR drcom::app] challenge 失败
[2021-05-10T09:17:31Z WARN  drcom::app] 160 秒后重试
[2021-05-10T09:20:11Z TRACE drcom::app] challenge sent(20) [1, 2, 71, 251, 9, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
[2021-05-10T09:20:11Z TRACE drcom::app] challenge recv(76) [2, 2, 167, 250, 38, 10, 115, 2, 0, 0, 1, 0, 243, 3, 232, 240, 0, 0, 0, 0, 172, 25, 148, 201, 11, 184, 168, 162, 0, 0, 41, 77, 77, 63, 0, 0, 0, 0, 216, 2, 0, 0, 1, 0, 32, 1, 13, 168, 200, 0, 255, 255, 0, 0, 0, 0, 0, 0, 242, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
[2021-05-10T09:20:11Z TRACE drcom::app] salt set(4) [38, 10, 115, 2]
[2021-05-10T09:20:11Z TRACE drcom::app] login sent(330) [3, 1, 0, 28, 25, 151, 162, 127, 88, 223, 58, 132, 80, 7, 252, 141, 58, 213, 102, 22, 50, 48, 49, 55, 50, 55, 53, 49, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 32, 7, 221, 10, 79, 221, 186, 225, 91, 51, 36, 232, 204, 227, 248, 108, 199, 65, 102, 21, 9, 40, 39, 164, 1, 192, 168, 31, 214, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 34, 33, 235, 84, 95, 49, 202, 18, 1, 0, 0, 0, 0, 88, 105, 97, 111, 77, 105, 32, 82, 111, 117, 116, 101, 114, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 8, 8, 8, 8, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 148, 0, 0, 0, 5, 0, 0, 0, 1, 0, 0, 0, 40, 10, 0, 0, 2, 0, 0, 0, 76, 105, 110, 117, 120, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 10, 0, 2, 12, 240, 153, 220, 88, 0, 0, 196, 157, 237, 162, 226, 62, 0, 0, 233, 19]
[2021-05-10T09:20:11Z TRACE drcom::app] login recv(76) [2, 2, 71, 251, 2, 12, 115, 2, 0, 0, 1, 0, 243, 3, 232, 240, 0, 0, 0, 0, 172, 25, 148, 201, 11, 184, 168, 162, 0, 0, 41, 77, 77, 63, 0, 0, 0, 0, 216, 2, 0, 0, 1, 0, 32, 1, 13, 168, 200, 0, 255, 255, 0, 0, 0, 0, 0, 0, 242, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
[2021-05-10T09:20:11Z ERROR drcom::app] 未知的登录错误
[2021-05-10T09:20:11Z WARN  drcom::app] 320 秒后重试
[2021-05-10T09:25:31Z TRACE drcom::app] challenge sent(20) [1, 2, 68, 252, 9, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
[2021-05-10T09:25:31Z TRACE drcom::app] challenge recv(5) [5, 0, 0, 5, 3]
[2021-05-10T09:25:31Z WARN  drcom::app] challenge err(5) [5, 0, 0, 5, 3]
[2021-05-10T09:25:31Z ERROR drcom::app] challenge 失败
[2021-05-10T09:25:31Z WARN  drcom::app] 640 秒后重试
```
</details>

<details>
<summary>
虎溪校区（D 校区）的配置，主要修改 <code>[signal]</code> 下的部分。
</summary>

```toml
[account]
username = ""
password = ""

[behavior]
log_level = "trace"
log_file = "./drcom.log"
ror_version = false
max_retry = 1

[server]
dhcp_server = "0.0.0.0"
host_ip = ""
host_name = ""
host_os = ""
mac = 0
primary_dns = "8.8.8.8"
server = "dr.com:61440"

[signal]
adapter_num = 0x00
auth_version = [0x2f, 0x00]
control_check_status = 0x00
ip_dog = 0x01
keep_alive_version = [0xdc, 0x02]
```
</details>

<details>
<summary>
沙坪坝校区（A, B 校区）的配置，主要修改 <code>[signal]</code> 下的部分。
</summary>

```toml
[account]
username = ""
password = ""

[behavior]
log_level = "trace"
log_file = "./drcom.log"
ror_version = false
max_retry = 10

[server]
dhcp_server = "0.0.0.0"
host_ip = ""
host_name = ""
host_os = ""
mac = 0
primary_dns = "8.8.8.8"
server = "dr.com:61440"

[signal]
adapter_num = 0x06
auth_version = [0x25, 0x00]
control_check_status = 0x20
ip_dog = 0x01
keep_alive_version = [0xd8, 0x02]
```
</details>